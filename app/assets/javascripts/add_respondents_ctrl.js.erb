(function() {
  "use strict";

  angular.module("app").controller("addRespondentsCtrl", ['$scope', '$http', 'Flash', function($scope, $http, Flash) {

    $scope.respondents = [];

    $scope.setup = function(evaluation_id) {
      $scope.evaluation_id = evaluation_id;
      $http.get("/api/v1/respondents?evaluation_id=" + $scope.evaluation_id).then(function (response) {
        $scope.respondents = response.data;
      });
    };

    // $scope.successAlert = function () {
    //     var message = '<strong>Well done!</strong> You successfully read this important alert message.';
    //     var id = Flash.create('success', message, 0, {class: 'custom-class', id: 'custom-id'}, true);
    //     // First argument (string) is the type of the flash alert.
    //     // Second argument (string) is the message displays in the flash alert (HTML is ok).
    //     // Third argument (number, optional) is the duration of showing the flash. 0 to not automatically hide flash (user needs to click the cross on top-right corner).
    //     // Fourth argument (object, optional) is the custom class and id to be added for the flash message created. 
    //     // Fifth argument (boolean, optional) is the visibility of close button for this flash.
    //     // Returns the unique id of flash message that can be used to call Flash.dismiss(id); to dismiss the flash message.
    // }

    $scope.addRespondentInput = function() {
      var respondent = {unsaved: true, evaluation_id: $scope.evaluation_id};
      $scope.respondents.push(respondent);
      $scope.sendEvaluation();
    };

    $scope.createRespondents = function() {
      var unsaved_respondents = $scope.respondents.filter(function (respondent) {
        return (respondent.unsaved == true);
      });
      $http.post('/api/v1/respondents/batch', {respondents: unsaved_respondents}).then(function(response) {
        Flash.create('success', '<strong>Respondents added.</strong> Success', 0, {class: 'custom-class', id: 'custom-id'}, true);
      });
    }

    $scope.removeRespondent = function(respondent) {
      if (respondent.unsaved) {
        $http.delete('/api/v1/respondents/' + respondent.id).then(function(response) {
          Flash.create('info', '<strong>Respondents removed.</strong> Success', 0, {class: 'custom-class', id: 'custom-id'}, true);
        });
      }
      var index = $scope.respondents.indexOf(respondent);
      $scope.respondents.splice(index, 1);
    };

    $scope.sendEvaluation = function () {
      var emailContents = {subject: scope.subject, message: scope.message};
      $http.post('api/v1/respondents/' + $scope.evaluation_id, {emailContents: emailContents}).then(function(response) {
        $scope.respondents = response.data;
      });
    }
    

    window.scope = $scope;

  }]);
}());